# MuleSoft Semgrep Rules â€” Security: Network & Transport
# Category : security
# Severity : ERROR / WARNING
# Use      : semgrep --config rules/security/network.yaml
---
rules:
  - id: mulesoft-insecure-http-listener
    message: >
      HTTP Listener is configured with plain HTTP (no TLS).
      Production listeners must use HTTPS: add a tlsContext referencing a valid keystore
      and set protocol="HTTPS" or configure tls:context inside the listener-config.
    severity: ERROR
    languages: [xml]
    metadata:
      category: security
      subcategory: [vuln]
      cwe: "CWE-319: Cleartext Transmission of Sensitive Information"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
      references:
        - https://docs.mulesoft.com/mule-runtime/latest/tls-configuration
    paths:
      include:
        - "*.dwl"
        - "*.yaml"
        - "*.xml"
    patterns:
      - pattern-regex: '<http:listener-config[^>]*protocol\s*=\s*"HTTP"[^>]*/>'

  - id: mulesoft-http-listener-missing-tls-context
    message: >
      HTTP Listener config does not reference a TLS context.
      Without TLS the connection is unencrypted. Add a tls:context child element
      or reference one via tlsContext attribute.
    severity: ERROR
    languages: [xml]
    metadata:
      category: security
      subcategory: [vuln]
      cwe: "CWE-319: Cleartext Transmission of Sensitive Information"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: MEDIUM
    paths:
      include:
        - "*.dwl"
        - "*.yaml"
        - "*.xml"
      exclude:
        - "pom.xml"
    patterns:
      - pattern: |
          <http:listener-config name="$NAME" ...>
            $...BODY
          </http:listener-config>
      - pattern-not: |
          <http:listener-config name="$NAME" ...>
            ...
            <tls:context ...>...</tls:context>
            ...
          </http:listener-config>
      - pattern-not-regex: '<http:listener-config[^>]*tlsContext\s*=\s*"\$\{'

  - id: mulesoft-http-requester-tls-disabled
    message: >
      HTTP Requester does not validate TLS/SSL certificates (insecureTransport or
      disableHostnameVerification enabled). This opens the connection to
      man-in-the-middle attacks. Remove the insecure setting in production.
    severity: ERROR
    languages: [xml]
    metadata:
      category: security
      subcategory: [vuln]
      cwe: "CWE-295: Improper Certificate Validation"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
    paths:
      include:
        - "*.dwl"
        - "*.yaml"
        - "*.xml"
      exclude:
        - "pom.xml"
    patterns:
      - pattern-either:
          - pattern-regex: '<tls:trust-store[^>]*insecure\s*=\s*"true"'
          - pattern-regex: '<http:requester-config[^>]*disableHostnameVerification\s*=\s*"true"'
          - pattern-regex: '<tls:context[^>]*enabledProtocols\s*=\s*"TLSv1[^2]'

  - id: mulesoft-weak-tls-version
    message: >
      TLS 1.0 or TLS 1.1 is explicitly enabled. These versions are deprecated
      and vulnerable (POODLE, BEAST). Enforce TLS 1.2 or TLS 1.3 only:
      enabledProtocols="TLSv1.2,TLSv1.3"
    severity: ERROR
    languages: [xml]
    metadata:
      category: security
      subcategory: [vuln]
      cwe: "CWE-326: Inadequate Encryption Strength"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH
      references:
        - https://docs.mulesoft.com/mule-runtime/latest/tls-configuration#tls-default
    paths:
      include:
        - "*.dwl"
        - "*.yaml"
        - "*.xml"
      exclude:
        - "pom.xml"
    patterns:
      - pattern-regex: 'enabledProtocols\s*=\s*"[^"]*TLSv1(?:\.[01])?[^2-9][^"]*"'

  - id: mulesoft-http-requester-plain-url
    message: >
      HTTP Requester uses a plain http:// URL. Outbound calls to external services
      should use HTTPS to protect data in transit. Update to https://.
    severity: WARNING
    languages: [xml]
    metadata:
      category: security
      subcategory: [audit]
      cwe: "CWE-319: Cleartext Transmission of Sensitive Information"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: MEDIUM
    paths:
      include:
        - "*.dwl"
        - "*.yaml"
        - "*.xml"
      exclude:
        - "pom.xml"
    patterns:
      - pattern-regex: '<http:request[^>]*url\s*=\s*"http://'
